on:
  cli:
    init:
      commit-sha: ${{ event.git.sha }}

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: code
    call: git/clone 2.0.0
    with:
      repository: https://github.com/rwx-cloud/calculator-demo.git
      ref: ${{ init.commit-sha }}
      github-token: ${{ github['rwx-cloud'].token }}

  - key: tool-versions
    use: code
    call: rwx/tool-versions 1.0.4
    filter: [.tool-versions]

  - key: node
    use: code
    call: nodejs/install 1.1.7
    with:
      node-version: ${{ tasks.tool-versions.values.nodejs }}
    filter:
      - package.json
      - package-lock.json

  - key: npm-install
    use: node
    run: npm ci
    filter:
      - package.json
      - package-lock.json

  - key: test
    use: npm-install
    run: npm test -- --json --testLocationInResults --outputFile jest-results.json
    outputs:
      test-results:
        - path: jest-results.json

  - key: build
    use: npm-install
    run: npm run build
